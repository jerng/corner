class ArrowOut{constructor(a){return this.okey=a,this.reads=[],this.updates=[],this.deletes=[],this}}class ArrowIn{constructor(a){return this.ikey=a,this.reads=[],this.updates=[],this.deletes=[],this}}class Algo{constructor(...a){if(1!==a.length)throw Error(`Algo.constructor : expected one and only one argument, received (${a.length}) arguments`);if("function"!=typeof a[0])throw Error(`Algo.constructor : typeof (argument provided) was not 'function'`);this.lambda=a[0];return this}}class Datum extends Function{toString(){return["Datum.toString/0 returned:",["a shallow copy of enumerable properties, { ... this }",{...this}],["Object.getOwnPropertyDescriptors ( this )",Object.getOwnPropertyDescriptors(this)]]}constructor(...a){switch(super(),this.key,this.value,this.arrows={in:{},out:{}},this.log={reads:[],updates:[],deletes:[]},this.cache={stale:!1,hits:[],misses:[]},a.length){case 0:return;case 1:switch(typeof a[0]){case"string":return this.key=a[0],this;case"object":return this.key=Object.keys(a[0])[0],this.value=a[0][this.key],this;default:throw Error(`Datum::constructor/1 called on n, where
                        (typeof n) is not 'string' or 'object';  branch undefined`);}default:throw Error(`datum.constructor/n called, branch for this arity is undefined.`);}}}class Graph extends Datum{toString(){return["Graph.toString/0 returned:",super.toString()]}constructor(...a){switch(super(),this.key="",this.value={},this.handlers=this.handlers(),this.datumHandler={apply:this.handlers.datumHandlerApply,deleteProperty:this.handlers.datumHandlerDeleteProperty,get:this.handlers.datumHandlerGet,set:this.handlers.datumHandlerSet},this.graphHandler={...this.datumHandler,apply:this.handlers.graphHandlerApply},this.proxy=new Proxy(this,this.graphHandler),a.length){case 0:return{graph:this,server:this.proxy};case 1:switch(a[0]){case"server":return this.proxy;case"graph":return this;default:throw Error(`Graph.constructor/1 called, the argument
                        was not understood.`);}break;default:throw Error(`Graph.constructor/n called, where no branch was
                defined for arity-n.`);}}deleteVertex(a){if(!(a in this.value))return!0;if("object"==typeof this.value[a]("datum").value)for(const b in this.value)if(b.startsWith(a+".")&&!this.deleteVertex(b))return!1;return delete this.value[a],!(a in this.value)}getVertex(a){if(a in this.value){let b=this.value[a]();return b instanceof Algo?b.lambda(this.proxy):"object"==typeof b?this.value[a]:b}}setVertex(...a){let b;switch(a.length){case 0:throw Error(`graph.setVertex/0 called; unsupported arity.`);case 1:console.warn(`graph.setVertex/1 : rewrite & test for this branch`);let c=a[0];b=new Datum(c),this.value[b.key]=new Proxy(b,this.datumHandler);}let c=a[0],d=a[1];if(!this.deleteVertex(c))return!1;if(b=new Datum({[c]:d}),"object"==typeof d)for(const a in d){if(!this.setVertex(c+"."+a,d[a]))return!1}if(d instanceof Algo){let a=new Proxy({},{get:(a,d)=>{"causal"in b.arrows.in||(b.arrows.in.causal=[]),b.arrows.in.causal.push(new ArrowIn(d));let e=this.value[d]("datum");"causal"in e.arrows.out||(e.arrows.out.causal=[]),e.arrows.out.causal.push(new ArrowOut(c))},set:(a,d)=>{"causal"in b.arrows.out||(b.arrows.out.causal=[]),b.arrows.out.causal.push(new ArrowOut(d)),d in this.value||this.setVertex(d,void 0);let e=this.value[d]("datum");"causal"in e.arrows.in||(dependencyDatum.arrows.in.causal=[]),e.arrows.in.causal.push(new ArrowIn(c))}});d.lambda(a)}return this.value[b.key]=new Proxy(b,this.datumHandler),this.value[b.key]()==a[1]}handlers(){return{datumHandlerDeleteProperty:(a,b)=>this.deleteVertex(b),datumHandlerGet:(a,b)=>{let c=(a.key?a.key+".":"")+b;return this.getVertex(c)},datumHandlerSet:(a,b,c)=>{let d=(a.key?a.key+".":"")+b;return this.setVertex(d,c)},datumHandlerApply:(a,b,c)=>{switch(c.length){case 0:let b=a;return"object"==typeof b.value?this.recoverEnumerableProperties(b):b.value;case 1:switch(c[0]){case"unproxy":return a;case"gopds":return Object.getOwnPropertyDescriptors(this);case"datum":return a;default:throw Error(`graph.datumHandleApply/1 : the argument was
                        not understood`);}default:throw Error(`graph.datumHandlerApply/n, where arity-n has no defined branch`);}},graphHandlerApply:(a,b,c)=>{switch(c.length){case 0:let b=a;return"object"==typeof b.value?this.recoverEnumerableProperties(b):b.value;case 1:switch(c[0]){case"unproxy":return a;case"gopds":return Object.getOwnPropertyDescriptors(this);case"graph":return a;case"server":return this.proxy;default:throw Error(`graph.graphHandlerApply/1 called;
                        the argument was not understood`);}default:throw Error(`graph.graphHandlerApply/n called, where no
                branch is defined for arity-n`);}}}}recoverEnumerableProperties(a){if(a instanceof Datum){for(const b in this.value)if(b.startsWith(a.key+".")){let c=b.slice(a.key.length+1);c.includes(".")||(a.value[c]=this.value[b]())}return a.value}for(const b in this.value)b.includes(".")||(a[b]=this.value[b]());return a}}globalThis.Algo=Algo,globalThis.Datum=Datum,globalThis.Graph=Graph;
